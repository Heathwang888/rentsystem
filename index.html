require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ‰‹æ©Ÿç§Ÿè³ƒå¾Œå°ç³»çµ±</title>
  <style>
    body { margin: 0; font-family: 'Noto Sans TC', sans-serif; background: #f4f4f4; }
    .sidebar {
      width: 200px; height: 100vh; background: #333; color: #fff;
      position: fixed; top: 0; left: 0; display: flex; flex-direction: column;
    }
    .sidebar button {
      background: none; border: none; color: #fff; padding: 20px;
      text-align: left; cursor: pointer; font-size: 16px;
    }
    .sidebar button:hover { background: #444; }
    .page-content { margin-left: 200px; padding: 20px; }
    .page { display: none; }
    .page.active { display: block; }

    form label { display: block; margin: 10px 0; }
    input, select { margin-left: 10px; }

    /* å®¢æˆ¶åˆ—è¡¨æ¨£å¼ */
    .customer-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }
    .card-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .right-section span {
      margin-left: 10px;
    }
    .card-summary {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .card-actions button {
      margin-right: 10px;
    }
    .filter-bar button.active {
      background: #f3cc00;
    }
    .note-input {
      width: 200px;
    }
    .modal {
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
    }
    .close-modal {
      float: right;
      cursor: pointer;
    }
    .status-tag {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    .status-tag.renting { background: #e3f2fd; color: #1976d2; }
    .status-tag.buyback { background: #e8f5e9; color: #2e7d32; }
    .status-tag.locked { background: #ffebee; color: #c62828; }
    .due-today {
      background: #fff3e0;
      color: #e65100;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    .balance-info {
      color: #d32f2f;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- å´é‚Šæ¬„ -->
  <div class="sidebar">
    <button onclick="showPage('dashboard')">ğŸ“Š ç¸½è¦½</button>
    <button onclick="showPage('list')">ğŸ“ å®¢æˆ¶åˆ—è¡¨</button>
    <button onclick="showPage('add')">â• æ–°å¢å®¢æˆ¶</button>
    <button onclick="showPage('edit')">âœï¸ ç·¨è¼¯å®¢æˆ¶</button>
    <button onclick="showPage('contract')">ğŸ“„ åˆç´„ç”¢è£½</button>
  </div>

  <!-- ä¸»è¦é é¢å€ -->
  <div class="page-content">
    <!-- ç¸½è¦½é  -->
    <div id="dashboard" class="page active">
      <h2>é€™æ˜¯ç¸½è¦½é </h2>
    </div>

    <!-- å®¢æˆ¶åˆ—è¡¨ -->
    <div id="list" class="page">
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="renting">ç§Ÿè³ƒä¸­</button>
        <button class="filter-btn" data-filter="buyback">å·²è²·å›</button>
        <button class="filter-btn" data-filter="locked">å‘†å¸³</button>
      </div>

      <div class="customer-list">
        <!-- å®¢æˆ¶å¡ç‰‡æœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ–°å¢å®¢æˆ¶ -->
    <div id="add" class="page">
      <h2>æ–°å¢å®¢æˆ¶</h2>
      <form id="add-customer-form" enctype="multipart/form-data">
        <label>å§“åï¼š<input type="text" name="name" required></label><br>
        <label>èº«åˆ†è­‰å­—è™Ÿï¼š<input type="text" name="idNumber" required></label><br>
        <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š<input type="text" name="phone" required></label><br>
        <label>æˆ¶ç±åœ°å€ï¼š<input type="text" name="address" required></label><br>
        <label>ç¾å±…åœ°å€ï¼š<input type="text" name="contactAddress" id="currentAddress"></label>
        <label><input type="checkbox" id="sameAsRegistered"> åŒæˆ¶ç±åœ°å€</label><br>

        <label>æ‰‹æ©Ÿå‹è™Ÿï¼š
          <select name="model" required>
            <option>iPhone 12</option>
            <option>iPhone 12 mini</option>
            <option>iPhone 12 Pro</option>
            <option>iPhone 12 Pro Max</option>
            <option>iPhone 13</option>
            <option>iPhone 13 mini</option>
            <option>iPhone 13 Pro</option>
            <option>iPhone 13 Pro Max</option>
            <option>iPhone 14</option>
            <option>iPhone 14 Plus</option>
            <option>iPhone 14 Pro</option>
            <option>iPhone 14 Pro Max</option>
            <option>iPhone 15</option>
            <option>iPhone 15 Plus</option>
            <option>iPhone 15 Pro</option>
            <option>iPhone 15 Pro Max</option>
          </select>
        </label><br>
        <label>IMEIï¼š<input type="text" name="imei" required></label><br>
        <label>åºè™Ÿï¼š<input type="text" name="serialNumber" required></label><br>
        <label>è²·è³£åƒ¹ï¼š<input type="number" name="salePrice" required></label><br>
        <label>é€±ç§Ÿé‡‘ï¼š<input type="number" name="rent" required></label><br>
        <label>æ”¶æ¬¾å¸³æˆ¶éŠ€è¡Œï¼š<input type="text" name="bank" required></label><br>
        <label>æˆ¶åï¼š<input type="text" name="bankAccountName" required></label><br>
        <label>å¸³è™Ÿï¼š<input type="text" name="bankAccountNumber" required></label><br>
        <label>åˆç´„èµ·å§‹æ—¥ï¼š<input type="date" name="contractDate" required></label><br>
        <label>åˆç´„ PDFï¼š<input type="file" name="contractFile" accept="application/pdf"></label><br>
        <label>èº«åˆ†è­‰æ­£é¢ï¼š<input type="file" name="idFront" accept="image/*"></label><br>
        <label>èº«åˆ†è­‰åé¢ï¼š<input type="file" name="idBack" accept="image/*"></label><br>
        <button type="submit">é€å‡ºæ–°å¢</button>
      </form>
    </div>

    <!-- ç·¨è¼¯å®¢æˆ¶ -->
    <div id="edit" class="page">
      <h2>ç·¨è¼¯å®¢æˆ¶è³‡æ–™</h2>
      <input type="text" id="searchKeyword" placeholder="è¼¸å…¥å§“åæˆ–èº«åˆ†è­‰å­—è™Ÿ">
      <button onclick="searchCustomer()">æœå°‹</button>
      <form id="edit-form" style="display:none;">
        <input type="hidden" name="id">
        <label>å§“åï¼š<input type="text" name="name" required></label>
        <label>èº«åˆ†è­‰å­—è™Ÿï¼š<input type="text" name="idNumber" required></label>
        <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š<input type="text" name="phone" required></label>
        <label>æˆ¶ç±åœ°å€ï¼š<input type="text" name="address" required></label>
        <label>ç¾å±…åœ°å€ï¼š<input type="text" name="contactAddress"></label>
        <label>æ‰‹æ©Ÿå‹è™Ÿï¼š<input type="text" name="model"></label>
        <label>IMEIï¼š<input type="text" name="imei"></label>
        <label>åºè™Ÿï¼š<input type="text" name="serialNumber"></label>
        <label>è²·è³£åƒ¹ï¼š<input type="number" name="salePrice"></label>
        <label>é€±ç§Ÿé‡‘ï¼š<input type="number" name="rent"></label>
        <label>æ”¶æ¬¾å¸³æˆ¶éŠ€è¡Œï¼š<input type="text" name="bank"></label>
        <label>æˆ¶åï¼š<input type="text" name="bankAccountName"></label>
        <label>å¸³è™Ÿï¼š<input type="text" name="bankAccountNumber"></label>
        <label>åˆç´„èµ·å§‹æ—¥ï¼š<input type="text" name="contractDate"></label>
        <button type="submit">ç¢ºèªä¿®æ”¹</button>
      </form>
    </div>

    <!-- åˆç´„ç”¢è£½ -->
    <div id="contract" class="page">
      <h2>åˆç´„ç”¢è£½ï¼ˆç©ºç™½é ï¼‰</h2>
    </div>
  </div>

  <!-- ç¹³æ¬¾å½ˆçª— -->
  <div id="payment-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>ç¹³æ¬¾ç´€éŒ„</h3>
      <label>ç¹³æ¬¾é‡‘é¡ï¼š</label>
      <input type="number" id="payment-amount" placeholder="è«‹è¼¸å…¥é‡‘é¡">
      <button id="submit-payment">ç¢ºèªç¹³æ¬¾</button>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://five-iridescent-flyaway.glitch.me';

    // åˆ‡æ›é é¢
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // å¦‚æœæ˜¯å®¢æˆ¶åˆ—è¡¨é ï¼Œè¼‰å…¥å®¢æˆ¶è³‡æ–™
      if (pageId === 'list') {
        loadCustomers();
      }
    }

    // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
    async function loadCustomers() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/customers`);
        const data = await response.json();
        
        const customerList = document.querySelector('.customer-list');
        customerList.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
        
        data.customers.forEach(customer => {
          const card = createCustomerCard(customer);
          customerList.appendChild(card);
        });
      } catch (error) {
        console.error('è¼‰å…¥å®¢æˆ¶åˆ—è¡¨å¤±æ•—:', error);
        alert('è¼‰å…¥å®¢æˆ¶åˆ—è¡¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // å‰µå»ºå®¢æˆ¶å¡ç‰‡
    function createCustomerCard(customer) {
      const card = document.createElement('div');
      card.className = 'customer-card';
      card.dataset.status = customer.status;
      card.dataset.id = customer._id;

      // è¨ˆç®—åˆ°æœŸæ—¥å’Œç‹€æ…‹
      const contractDate = new Date(customer.contractDate);
      const dueDate = new Date(contractDate);
      dueDate.setDate(dueDate.getDate() + 7);
      const today = new Date();
      
      let statusTag = '';
      if (customer.status === 'renting') {
        if (today.toDateString() === dueDate.toDateString()) {
          statusTag = 'æœ¬æ—¥æ‡‰ç¹³æ¬¾';
        } else if (today > dueDate) {
          const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
          statusTag = `é€¾æœŸ ${daysOverdue} æ—¥`;
        }
      }

      // è¨ˆç®—ç´¯è¨ˆç¹³æ¬¾å’Œæœªä»˜é‡‘é¡
      const totalPaid = customer.paymentRecords?.reduce((sum, record) => sum + record.amount, 0) || 0;
      const unpaidAmount = customer.rent - (totalPaid % customer.rent);

      card.innerHTML = `
        <div class="card-header">
          <div class="card-top">
            <strong>${customer.name}</strong>
            ${customer.notes ? `<span class="note-tag">ï¼ˆ${customer.notes}ï¼‰</span>` : ''}
            <div class="right-section">
              ${unpaidAmount > 0 ? `<span class="balance-info">å°šæœ‰é¤˜é¡ $${unpaidAmount} å…ƒ</span>` : ''}
              <span class="status-tag ${customer.status}">${getStatusText(customer.status)}</span>
              ${statusTag ? `<span class="due-today">${statusTag}</span>` : ''}
            </div>
          </div>
          <div class="card-summary">
            <span>${customer.model}</span> ï½œ 
            <span>åƒ¹é‡‘ï¼š$${customer.salePrice}</span> ï½œ 
            <span>ç§Ÿé‡‘ï¼š$${customer.rent}</span>
            <button class="pay-btn" onclick="showPaymentModal('${customer._id}', ${customer.rent})">ç¹³æ¬¾</button>
          </div>
          <button class="toggle-detail" onclick="toggleDetails(this)">â–¼ å±•é–‹</button>
        </div>

        <div class="card-detail" style="display:none;">
          <p><strong>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</strong>${customer.phone}</p>
          <p><strong>èº«åˆ†è­‰å­—è™Ÿï¼š</strong>${customer.idNumber}</p>
          <p><strong>æ‰‹æ©Ÿå‹è™Ÿï¼š</strong>${customer.model}</p>
          <p><strong>IMEIï¼š</strong>${customer.imei}</p>
          <p><strong>åºè™Ÿï¼š</strong>${customer.serialNumber}</p>
          <p><strong>æˆ¶ç±åœ°å€ï¼š</strong>${customer.address}</p>
          <p><strong>é€šè¨Šåœ°å€ï¼š</strong>${customer.contactAddress || 'åŒä¸Š'}</p>
          <p><strong>åˆç´„èµ·å§‹æ—¥ï¼š</strong>${formatDate(customer.contractDate)}</p>
          <p><strong>è²·è³£åƒ¹é‡‘ï¼š</strong>$${customer.salePrice}</p>
          <p><strong>ç§Ÿé‡‘ï¼š</strong>$${customer.rent} / é€±</p>
          <p><strong>æ’¥æ¬¾å¸³æˆ¶ï¼š</strong>${customer.bank} / æˆ¶åï¼š${customer.bankAccountName} / å¸³è™Ÿï¼š${customer.bankAccountNumber}</p>
          <p><strong>æ­·å²ç¹³æ¬¾ç´€éŒ„ï¼š</strong></p>
          <ul>
            ${customer.paymentRecords?.map(record => 
              `<li>${formatDate(record.date)} - $${record.amount}</li>`
            ).join('') || ''}
          </ul>
          <p><strong>å‚™è¨»ï¼š</strong> 
            <input type="text" class="note-input" placeholder="è¼¸å…¥å‚™è¨»..." value="${customer.notes || ''}">
            <button class="save-note" onclick="saveNote('${customer._id}', this)">ç¢ºèª</button>
          </p>

          <div class="card-actions">
            <button class="download-contract" onclick="downloadFile('${customer._id}', 'contract')">ä¸‹è¼‰åˆç´„</button>
            <button class="download-id" onclick="downloadFile('${customer._id}', 'id')">ä¸‹è¼‰èº«åˆ†è­‰</button>
            <button class="download-disbursement" onclick="downloadFile('${customer._id}', 'disbursement')">ä¸‹è¼‰æ’¥æ¬¾æ°´å–®</button>
            <button class="mark-locked" onclick="markAsLocked('${customer._id}')">å‘†å¸³(é–æ©Ÿ)</button>
          </div>
        </div>
      `;

      return card;
    }

    // é¡¯ç¤ºç¹³æ¬¾å½ˆçª—
    function showPaymentModal(customerId, rent) {
      const modal = document.getElementById('payment-modal');
      const amountInput = document.getElementById('payment-amount');
      const submitBtn = document.getElementById('submit-payment');
      
      amountInput.value = rent; // é è¨­é¡¯ç¤ºç§Ÿé‡‘é‡‘é¡
      
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      const newSubmitBtn = submitBtn.cloneNode(true);
      submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
      
      // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
      newSubmitBtn.addEventListener('click', async () => {
        const amount = parseFloat(amountInput.value);
        if (!amount || amount <= 0) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}/payment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount })
          });
          
          if (!response.ok) {
            throw new Error('ç¹³æ¬¾å¤±æ•—');
          }
          
          modal.style.display = 'none';
          alert('âœ… ç¹³æ¬¾æˆåŠŸ');
          loadCustomers(); // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
        } catch (error) {
          console.error('ç¹³æ¬¾å¤±æ•—:', error);
          alert('ç¹³æ¬¾å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      });
      
      modal.style.display = 'block';
    }

    // ä¿å­˜å‚™è¨»
    async function saveNote(customerId, button) {
      const input = button.previousElementSibling;
      const notes = input.value;
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}/notes`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ notes })
        });
        
        if (!response.ok) {
          throw new Error('æ›´æ–°å‚™è¨»å¤±æ•—');
        }
        
        alert('âœ… å‚™è¨»æ›´æ–°æˆåŠŸ');
        loadCustomers(); // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
      } catch (error) {
        console.error('æ›´æ–°å‚™è¨»å¤±æ•—:', error);
        alert('æ›´æ–°å‚™è¨»å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æ¨™è¨˜ç‚ºå‘†å¸³
    async function markAsLocked(customerId) {
      if (!confirm('ç¢ºå®šè¦å°‡æ­¤å®¢æˆ¶æ¨™è¨˜ç‚ºå‘†å¸³å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}/lock`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          throw new Error('æ¨™è¨˜å‘†å¸³å¤±æ•—');
        }
        
        alert('âœ… å·²æ¨™è¨˜ç‚ºå‘†å¸³');
        loadCustomers(); // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
      } catch (error) {
        console.error('æ¨™è¨˜å‘†å¸³å¤±æ•—:', error);
        alert('æ¨™è¨˜å‘†å¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ä¸‹è¼‰æ–‡ä»¶
    async function downloadFile(customerId, type) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}/files/${type}`);
        
        if (!response.ok) {
          throw new Error('ä¸‹è¼‰æ–‡ä»¶å¤±æ•—');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${type}-${customerId}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('ä¸‹è¼‰æ–‡ä»¶å¤±æ•—:', error);
        alert('ä¸‹è¼‰æ–‡ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // åˆ‡æ›è©³ç´°è³‡è¨Šé¡¯ç¤º
    function toggleDetails(button) {
      const detail = button.closest('.customer-card').querySelector('.card-detail');
      detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW');
    }

    // ç²å–ç‹€æ…‹æ–‡å­—
    function getStatusText(status) {
      const statusMap = {
        'renting': 'ç§Ÿè³ƒä¸­',
        'buyback': 'å·²è²·å›',
        'locked': 'å‘†å¸³'
      };
      return statusMap[status] || status;
    }

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', () => {
      // ç¯©é¸æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const filter = btn.dataset.filter;
          document.querySelectorAll('.customer-card').forEach(card => {
            card.style.display = (filter === 'all' || card.dataset.status === filter) ? 'block' : 'none';
          });
        });
      });

      // é—œé–‰ç¹³æ¬¾è¦–çª—
      document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('payment-modal').style.display = 'none';
      });

      // åŒæˆ¶ç±åœ°å€å‹¾é¸
      const sameBox = document.getElementById('sameAsRegistered');
      if (sameBox) {
        sameBox.addEventListener('change', () => {
          const reg = document.querySelector('[name="address"]');
          const cur = document.getElementById('currentAddress');
          if (sameBox.checked) cur.value = reg.value;
        });
      }

      // æ–°å¢å®¢æˆ¶è¡¨å–®æäº¤
      const addForm = document.getElementById('add-customer-form');
      if (addForm) {
        addForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(this);

          try {
            const response = await fetch(`${API_BASE_URL}/api/customers`, {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              throw new Error('æ–°å¢å®¢æˆ¶å¤±æ•—');
            }

            alert('âœ… æ–°å¢æˆåŠŸ');
            this.reset();
            showPage('list'); // åˆ‡æ›åˆ°åˆ—è¡¨é 
            loadCustomers(); // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
          } catch (error) {
            console.error('æ–°å¢å®¢æˆ¶å¤±æ•—:', error);
            alert('æ–°å¢å®¢æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        });
      }
    });
  </script>
</body>
</html> 
const { v4: uuidv4 } = require('uuid');

const app = express();
const port = process.env.PORT || 3000;

// è¨­ç½® Mongoose strictQuery
mongoose.set('strictQuery', false);

// MongoDB é€£æ¥
const mongoUri = process.env.MONGODB_URI;
console.log('Connecting to MongoDB at:', mongoUri.replace(/\/\/[^@]+@/, '//****:****@'));

mongoose.connect(mongoUri, {
  useNewUrlParser: true,
  useUnifiedTopology: true
})
.then(() => console.log('Connected to MongoDB Atlas'))
.catch(err => {
  console.error('MongoDB connection error:', err);
  process.exit(1);
});

// å®šç¾©å®¢æˆ¶è³‡æ–™æ¨¡å‹
const customerSchema = new mongoose.Schema({
  name: { type: String, required: true },
  idNumber: { type: String, required: true },
  phone: { type: String, required: true },
  address: { type: String, required: true },
  contactAddress: { type: String },
  model: { type: String, required: true },
  imei: { type: String, required: true },
  screenPassword: { type: String },
  salePrice: { type: Number, required: true },
  rent: { type: Number, required: true },
  contractDate: { type: Date, required: true },
  files: {
    contractFile: String,
    idFront: String,
    idBack: String
  },
  status: { type: String, default: 'renting' },
  createdAt: { type: Date, default: Date.now },
  lastPaymentDate: { type: Date },
  paymentRecords: [{
    date: { type: Date, required: true },
    amount: { type: Number, required: true }
  }],
  paidAmount: { type: Number, default: 0 },
  unpaidAmount: { type: Number, default: 0 },
  notes: { type: String },
  buybackDate: { type: Date },
  lockDate: { type: Date }
});

const Customer = mongoose.model('Customer', customerSchema, 'customers');

// ä¸­é–“ä»¶è¨­ç½®
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// æ ¹è·¯ç”±è™•ç†
app.get('/', (req, res) => {
  res.send('Phone Contract Management API is running');
});

// è¨­ç½®æ–‡ä»¶ä¸Šå‚³
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = 'uploads';
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ 
  storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // é™åˆ¶æ–‡ä»¶å¤§å°ç‚º 5MB
  }
});

// API è·¯ç”±

// ç²å–å®¢æˆ¶åˆ—è¡¨ï¼ˆåˆ†é ï¼‰
app.get('/api/customers', async (req, res) => {
  try {
    const { page = 1, limit = 5 } = req.query;
    const skip = (page - 1) * limit;
    
    const customers = await Customer.find()
      .sort({ createdAt: -1 })
      .skip(skip)
      .limit(parseInt(limit));
    
    const total = await Customer.countDocuments();
    
    res.json({
      customers,
      total,
      page: parseInt(page),
      limit: parseInt(limit)
    });
  } catch (error) {
    res.status(500).json({ error: 'ç²å–å®¢æˆ¶åˆ—è¡¨å¤±æ•—' });
  }
});

// æœå°‹å®¢æˆ¶
app.get('/api/customers/search', async (req, res) => {
  try {
    const { q } = req.query;
    const { page = 1, limit = 5 } = req.query;
    const skip = (page - 1) * limit;
    
    const query = {
      $or: [
        { name: { $regex: q, $options: 'i' } },
        { idNumber: { $regex: q, $options: 'i' } },
        { phone: { $regex: q, $options: 'i' } }
      ]
    };
    
    const customers = await Customer.find(query)
      .sort({ createdAt: -1 })
      .skip(skip)
      .limit(parseInt(limit));
    
    const total = await Customer.countDocuments(query);
    
    res.json({
      customers,
      total,
      page: parseInt(page),
      limit: parseInt(limit)
    });
  } catch (error) {
    res.status(500).json({ error: 'æœå°‹å®¢æˆ¶å¤±æ•—' });
  }
});

// å‰µå»ºæ–°å®¢æˆ¶
app.post('/api/customers', upload.fields([
  { name: 'contractFile', maxCount: 1 },
  { name: 'idFront', maxCount: 1 },
  { name: 'idBack', maxCount: 1 }
]), async (req, res) => {
  try {
    console.log('Received request body:', req.body);
    console.log('Received files:', req.files);

    // é©—è­‰å¿…å¡«æ¬„ä½
    const requiredFields = ['name', 'idNumber', 'phone', 'address', 'phoneModel', 'imei', 'price', 'rent', 'contractDate'];
    for (const field of requiredFields) {
      if (!req.body[field]) {
        return res.status(400).json({ error: `ç¼ºå°‘å¿…å¡«æ¬„ä½: ${field}` });
      }
    }

    // è½‰æ›æ•¸å€¼é¡å‹
    const customerData = {
      name: req.body.name,
      idNumber: req.body.idNumber,
      phone: req.body.phone,
      address: req.body.address,
      contactAddress: req.body.mailingAddress,
      model: req.body.phoneModel,
      imei: req.body.imei,
      screenPassword: req.body.screenPassword,
      salePrice: parseFloat(req.body.price),
      rent: parseFloat(req.body.rent),
      contractDate: new Date(req.body.contractDate),
      files: {
        contractFile: req.files?.contractFile?.[0]?.filename || null,
        idFront: req.files?.idFront?.[0]?.filename || null,
        idBack: req.files?.idBack?.[0]?.filename || null
      }
    };

    console.log('Processed customer data:', customerData);

    const customer = new Customer(customerData);
    await customer.save();
    
    res.status(201).json(customer);
  } catch (error) {
    console.error('Error creating customer:', error);
    res.status(500).json({ 
      error: 'å‰µå»ºå®¢æˆ¶å¤±æ•—',
      details: error.message 
    });
  }
});

// æ›´æ–°å®¢æˆ¶è³‡è¨Š
app.put('/api/customers/:id', async (req, res) => {
  try {
    const customer = await Customer.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true }
    );
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    res.json(customer);
  } catch (error) {
    res.status(500).json({ error: 'æ›´æ–°å®¢æˆ¶å¤±æ•—' });
  }
});

// æ›´æ–°å®¢æˆ¶ç‹€æ…‹
app.patch('/api/customers/:id/status', async (req, res) => {
  try {
    const { status, paidAmount, unpaidAmount } = req.body;
    const updateData = { status };
    
    if (status === 'partial' && paidAmount && unpaidAmount) {
      updateData.paidAmount = paidAmount;
      updateData.unpaidAmount = unpaidAmount;
    }
    
    const customer = await Customer.findByIdAndUpdate(
      req.params.id,
      updateData,
      { new: true }
    );
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    res.json(customer);
  } catch (error) {
    console.error('Error updating customer status:', error);
    res.status(500).json({ error: 'æ›´æ–°å®¢æˆ¶ç‹€æ…‹å¤±æ•—' });
  }
});

// æ›´æ–°å®¢æˆ¶å‚™è¨»
app.patch('/api/customers/:id/notes', async (req, res) => {
  try {
    const { notes } = req.body;
    const customer = await Customer.findByIdAndUpdate(
      req.params.id,
      { notes },
      { new: true }
    );
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    res.json(customer);
  } catch (error) {
    console.error('Error updating customer notes:', error);
    res.status(500).json({ error: 'æ›´æ–°å®¢æˆ¶å‚™è¨»å¤±æ•—' });
  }
});

// åˆªé™¤å®¢æˆ¶
app.delete('/api/customers/:id', async (req, res) => {
  try {
    const customer = await Customer.findById(req.params.id);
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    // åˆªé™¤ç›¸é—œæ–‡ä»¶
    if (customer.files) {
      Object.values(customer.files).forEach(filename => {
        if (filename) {
          const filePath = path.join('uploads', filename);
          if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
          }
        }
      });
    }
    
    await customer.remove();
    res.status(204).send();
  } catch (error) {
    res.status(500).json({ error: 'åˆªé™¤å®¢æˆ¶å¤±æ•—' });
  }
});

// ç²å–å®¢æˆ¶æ–‡ä»¶
app.get('/api/customers/:id/files/:type', async (req, res) => {
  try {
    const customer = await Customer.findById(req.params.id);
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    let filePath;
    if (req.params.type === 'contract') {
      if (!customer.files?.contractFile) {
        return res.status(404).json({ error: 'åˆç´„æ–‡ä»¶ä¸å­˜åœ¨' });
      }
      filePath = path.join('uploads', customer.files.contractFile);
    } else if (req.params.type === 'id') {
      if (!customer.files?.idFront || !customer.files?.idBack) {
        return res.status(404).json({ error: 'èº«åˆ†è­‰æ–‡ä»¶ä¸å­˜åœ¨' });
      }
      // é€™è£¡å¯ä»¥å¯¦ç¾åˆä½µ PDF çš„é‚è¼¯ï¼Œæš«æ™‚åªè¿”å›æ­£é¢
      filePath = path.join('uploads', customer.files.idFront);
    } else {
      return res.status(400).json({ error: 'ç„¡æ•ˆçš„æ–‡ä»¶é¡å‹' });
    }
    
    if (!fs.existsSync(filePath)) {
      return res.status(404).json({ error: 'æ–‡ä»¶ä¸å­˜åœ¨' });
    }
    
    res.sendFile(path.resolve(filePath));
  } catch (error) {
    console.error('Error getting customer file:', error);
    res.status(500).json({ error: 'ç²å–æ–‡ä»¶å¤±æ•—' });
  }
});

// è™•ç†ç¹³æ¬¾
app.post('/api/customers/:id/payment', async (req, res) => {
  try {
    const { amount } = req.body;
    if (!amount || amount <= 0) {
      return res.status(400).json({ error: 'ç„¡æ•ˆçš„ç¹³æ¬¾é‡‘é¡' });
    }

    const customer = await Customer.findById(req.params.id);
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }

    // æ›´æ–°ç¹³æ¬¾è¨˜éŒ„
    if (!customer.paymentRecords) {
      customer.paymentRecords = [];
    }

    customer.paymentRecords.push({
      date: new Date(),
      amount: amount
    });

    // æ›´æ–°æœ€å¾Œç¹³æ¬¾æ—¥æœŸ
    customer.lastPaymentDate = new Date();

    // å¦‚æœæœ‰æœªä»˜é‡‘é¡ï¼Œå‰‡æ›´æ–°
    if (customer.unpaidAmount) {
      customer.unpaidAmount = Math.max(0, customer.unpaidAmount - amount);
    }

    await customer.save();
    res.json(customer);
  } catch (error) {
    console.error('Error processing payment:', error);
    res.status(500).json({ error: 'è™•ç†ç¹³æ¬¾å¤±æ•—' });
  }
});

// è²·å›è™•ç†
app.post('/api/customers/:id/buyback', async (req, res) => {
  try {
    const customer = await Customer.findByIdAndUpdate(
      req.params.id,
      { 
        status: 'buyback',
        buybackDate: new Date()
      },
      { new: true }
    );
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    res.json(customer);
  } catch (error) {
    console.error('Error processing buyback:', error);
    res.status(500).json({ error: 'è™•ç†è²·å›å¤±æ•—' });
  }
});

// å‘†å¸³é–æ©Ÿè™•ç†
app.post('/api/customers/:id/lock', async (req, res) => {
  try {
    const customer = await Customer.findByIdAndUpdate(
      req.params.id,
      { 
        status: 'locked',
        lockDate: new Date()
      },
      { new: true }
    );
    
    if (!customer) {
      return res.status(404).json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' });
    }
    
    res.json(customer);
  } catch (error) {
    console.error('Error processing lock:', error);
    res.status(500).json({ error: 'è™•ç†é–æ©Ÿå¤±æ•—' });
  }
});

// éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'ä¼ºæœå™¨éŒ¯èª¤' });
});

// å•Ÿå‹•ä¼ºæœå™¨
app.listen(port, () => {
  console.log(`Server is running on port ${port}`);
}); 
