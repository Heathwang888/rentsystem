  <style>
    body { margin: 0; font-family: 'Noto Sans TC', sans-serif; background: #f4f4f4; }
    .sidebar {
      width: 200px; height: 100vh; background: #333; color: #fff;
      position: fixed; top: 0; left: 0; display: flex; flex-direction: column;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar button {
      background: none; border: none; color: #fff; padding: 20px;
      text-align: left; cursor: pointer; font-size: 16px;
      transition: background-color 0.3s;
    }
    .sidebar button:hover { background: #444; }
    .page-content { 
      margin-left: 200px; 
      padding: 20px;
      min-height: 100vh;
      background: #f4f4f4;
    }
    .page { 
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .page.active { display: block; }

    form label { 
      display: block; 
      margin: 10px 0;
      font-weight: 500;
    }
    input, select { 
      margin-left: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    .filter-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .filter-btn {
      padding: 8px 16px;
      background: #f8f9fa;
      color: #333;
      border: 1px solid #ddd;
    }
    .filter-btn.active {
      background: #f3cc00;
      border-color: #f3cc00;
      color: #333;
    }
    .customer-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .status-tag {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      background: #28a745;
      color: white;
    }
    .due-today {
      color: #dc3545;
      font-weight: bold;
    }
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .page-content {
        margin-left: 0;
      }
      .sidebar button {
        padding: 10px;
        flex: 1;
        min-width: 100px;
      }
    }
  </style> 
  <script>
    const API_BASE_URL = 'https://five-iridescent-flyaway.glitch.me/api';

    // 切換頁面
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // 當切換到客戶列表頁時，載入客戶資料
      if (pageId === 'list') {
        loadCustomers();
      }
    }

    // 載入客戶列表
    async function loadCustomers() {
      try {
        const response = await fetch(`${API_BASE_URL}/customers`);
        const data = await response.json();
        displayCustomers(data.customers);
      } catch (error) {
        console.error('載入客戶列表失敗:', error);
        alert('載入客戶列表失敗，請稍後再試');
      }
    }

    // 顯示客戶列表
    function displayCustomers(customers) {
      const customerList = document.querySelector('.customer-list');
      customerList.innerHTML = '';

      customers.forEach(customer => {
        const card = createCustomerCard(customer);
        customerList.appendChild(card);
      });
    }

    // 創建客戶卡片
    function createCustomerCard(customer) {
      const card = document.createElement('div');
      card.className = 'customer-card';
      card.dataset.status = customer.status;

      const statusClass = {
        'renting': '租賃中',
        'buyback': '已買回',
        'locked': '呆帳'
      };

      card.innerHTML = `
        <div class="card-header">
          <div class="card-top">
            <strong>${customer.name}</strong>
            ${customer.notes ? `<span class="note-tag">（${customer.notes}）</span>` : ''}
            <div class="right-section">
              <span class="balance-info">尚有餘額 $${customer.unpaidAmount || 0} 元</span>
              <span class="status-tag">${statusClass[customer.status]}</span>
              ${customer.unpaidAmount > 0 ? '<span class="due-today">本日應繳款</span>' : ''}
            </div>
          </div>
          <div class="card-summary">
            <span>${customer.model}</span> ｜ 
            <span>價金：$${customer.salePrice}</span> ｜ 
            <span>租金：$${customer.rent}</span>
            <button class="pay-btn" onclick="showPaymentModal('${customer._id}')">繳款</button>
          </div>
          <button class="toggle-detail" onclick="toggleDetails(this)">▼ 展開</button>
        </div>
        <div class="card-detail" style="display:none;">
          <p><strong>手機號碼：</strong>${customer.phone}</p>
          <p><strong>身分證字號：</strong>${customer.idNumber}</p>
          <p><strong>手機型號：</strong>${customer.model}</p>
          <p><strong>IMEI：</strong>${customer.imei}</p>
          <p><strong>合約起始日：</strong>${new Date(customer.contractDate).toLocaleDateString()}</p>
          <p><strong>買賣價金：</strong>$${customer.salePrice}</p>
          <p><strong>租金：</strong>$${customer.rent} / 週</p>
          <p><strong>備註：</strong> 
            <input type="text" class="note-input" placeholder="輸入備註..." value="${customer.notes || ''}">
            <button class="save-note" onclick="saveNote('${customer._id}', this)">確認</button>
          </p>
          <div class="card-actions">
            <button onclick="downloadContract('${customer._id}')">下載合約</button>
            <button onclick="downloadId('${customer._id}')">下載身分證</button>
            <button onclick="markLocked('${customer._id}')">呆帳(鎖機)</button>
          </div>
        </div>
      `;
      return card;
    }

    // 顯示繳款視窗
    function showPaymentModal(customerId) {
      const modal = document.getElementById('payment-modal');
      modal.style.display = 'block';
      modal.dataset.customerId = customerId;
    }

    // 處理繳款
    async function submitPayment() {
      const modal = document.getElementById('payment-modal');
      const customerId = modal.dataset.customerId;
      const amount = document.getElementById('payment-amount').value;

      try {
        const response = await fetch(`${API_BASE_URL}/customers/${customerId}/payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ amount: parseFloat(amount) })
        });

        if (response.ok) {
          alert('繳款成功');
          modal.style.display = 'none';
          loadCustomers(); // 重新載入客戶列表
        } else {
          throw new Error('繳款失敗');
        }
      } catch (error) {
        console.error('繳款失敗:', error);
        alert('繳款失敗，請稍後再試');
      }
    }

    // 儲存備註
    async function saveNote(customerId, button) {
      const noteInput = button.previousElementSibling;
      const note = noteInput.value;

      try {
        const response = await fetch(`${API_BASE_URL}/customers/${customerId}/notes`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ notes: note })
        });

        if (response.ok) {
          alert('備註更新成功');
          loadCustomers(); // 重新載入客戶列表
        } else {
          throw new Error('更新備註失敗');
        }
      } catch (error) {
        console.error('更新備註失敗:', error);
        alert('更新備註失敗，請稍後再試');
      }
    }

    // 標記為呆帳
    async function markLocked(customerId) {
      if (!confirm('確定要將此客戶標記為呆帳嗎？')) return;

      try {
        const response = await fetch(`${API_BASE_URL}/customers/${customerId}/lock`, {
          method: 'POST'
        });

        if (response.ok) {
          alert('已標記為呆帳');
          loadCustomers(); // 重新載入客戶列表
        } else {
          throw new Error('標記呆帳失敗');
        }
      } catch (error) {
        console.error('標記呆帳失敗:', error);
        alert('標記呆帳失敗，請稍後再試');
      }
    }

    // 下載合約
    async function downloadContract(customerId) {
      try {
        const response = await fetch(`${API_BASE_URL}/customers/${customerId}/files/contract`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `contract_${customerId}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } else {
          throw new Error('下載合約失敗');
        }
      } catch (error) {
        console.error('下載合約失敗:', error);
        alert('下載合約失敗，請稍後再試');
      }
    }

    // 下載身分證
    async function downloadId(customerId) {
      try {
        const response = await fetch(`${API_BASE_URL}/customers/${customerId}/files/id`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `id_${customerId}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } else {
          throw new Error('下載身分證失敗');
        }
      } catch (error) {
        console.error('下載身分證失敗:', error);
        alert('下載身分證失敗，請稍後再試');
      }
    }

    // 切換詳細資料顯示
    function toggleDetails(button) {
      const detail = button.closest('.customer-card').querySelector('.card-detail');
      detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
    }

    // 初始化頁面
    document.addEventListener('DOMContentLoaded', () => {
      // 篩選按鈕事件
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const filter = btn.dataset.filter;
          document.querySelectorAll('.customer-card').forEach(card => {
            card.style.display = (filter === 'all' || card.dataset.status === filter) ? 'block' : 'none';
          });
        });
      });

      // 關閉繳款視窗
      document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('payment-modal').style.display = 'none';
      });

      // 提交繳款
      document.getElementById('submit-payment').addEventListener('click', submitPayment);

      // 同戶籍地址勾選
      const sameBox = document.getElementById('sameAsRegistered');
      if (sameBox) {
        sameBox.addEventListener('change', () => {
          const reg = document.querySelector('[name="registeredAddress"]');
          const cur = document.getElementById('currentAddress');
          if (sameBox.checked) cur.value = reg.value;
        });
      }

      // 新增客戶表單提交
      document.getElementById('add-customer-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        try {
          const response = await fetch(`${API_BASE_URL}/customers`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            alert('新增客戶成功');
            this.reset();
            showPage('list');
            loadCustomers();
          } else {
            throw new Error('新增客戶失敗');
          }
        } catch (error) {
          console.error('新增客戶失敗:', error);
          alert('新增客戶失敗，請稍後再試');
        }
      });
    });
  </script> 
